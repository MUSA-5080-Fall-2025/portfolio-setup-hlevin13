subtitle = "Based on Chicago 311 Service Requests",
fill = "Request Count"
) +
coord_sf()+
theme_minimal(base_size = 14)+
theme(
plot.title = element_text(face = "bold"),
plot.subtitle = element_text(face = "italic"),
legend.position = "right"
)
# check projections
chicago_poly <- st_transform(chicago, crs_proj)
graffiti_points <- st_transform(graffiti_sf, crs_proj)
fishnet <- st_transform(fishnet, crs_proj)
### K-NEAREST NEIGHBOR FEATURES
nn_dist <- get.knnx(
data = st_coordinates(graffiti_points),
query = st_coordinates(st_centroid(fishnet)),
k = 1
)
fishnet$graffiti_nn <- nn_dist$nn.dist[,1]
#### LOCAL MORAN'S I ANALYSIS
neighbors <- poly2nb(fishnet)
weights <- nb2listw(neighbors, style = "W", zero.policy = TRUE)
local_moran <- localmoran(
fishnet$countGraffiti,
weights,
zero.policy = TRUE
)
fishnet <- fishnet %>%
mutate(
local_I = local_moran[, "Ii"],
p_value = local_moran[, "Pr(z != E(Ii))"],
z_score = local_moran[, "Z.Ii"],
hotspot = ifelse(local_I > 0 & p_value < 0.05, 1, 0)
)
### DISTANCE TO HOTSPOT
hotspot_cells <- filter(fishnet, hotspot == 1)
hotspot_dist <- get.knnx(
data = st_coordinates(st_centroid(hotspot_cells)),
query = st_coordinates(st_centroid(fishnet)),
k = 1
)
fishnet$hotspot_nn <- hotspot_dist$nn.dist[, 1]
#### VISUALIZATION
# Create comparison maps
p1 <- ggplot(fishnet) +
geom_sf(aes(fill = graffiti_nn), color = NA, alpha = 0.8) +
scale_fill_viridis_c(name = "Distance (m)", option = "plasma", trans = "sqrt") +
labs(title = "Distance to Nearest Graffiti Removal Request") +
coord_sf() +
theme_minimal(base_size = 14)
p2 <- ggplot(fishnet) +
geom_sf(aes(fill = hotspot_nn), color = NA, alpha = 0.8) +
scale_fill_viridis_c(name = "Distance (m)", option = "magma", trans = "sqrt") +
labs(title = "Distance to Nearest Hotspot") +
coord_sf() +
theme_minimal(base_size = 14)
grid.arrange(p1, p2, ncol = 1)
#### POISSION MODEL
model_poisson <- glm(
countGraffiti ~ graffiti_nn + hotspot_nn,
data = fishnet,
family = poisson(link = "log")
)
exp(coef(model_poisson))
### SCALE FIT
fishnet_scale <- fishnet %>%
mutate(
log_graffiti = log1p(graffiti_nn),
log_hotspot = log1p(hotspot_nn)
)
#### NEGATIVE BINOMIAL REGRESSION
model_nb <- glm.nb(
countGraffiti ~ log_graffiti + log_hotspot,
data = fishnet_scale
)
install.package("MASS")
install.packages("MASS")
install.packages("MASS")
library(MASS)
# check projections
chicago_poly <- st_transform(chicago, crs_proj)
graffiti_points <- st_transform(graffiti_sf, crs_proj)
fishnet <- st_transform(fishnet, crs_proj)
### K-NEAREST NEIGHBOR FEATURES
nn_dist <- get.knnx(
data = st_coordinates(graffiti_points),
query = st_coordinates(st_centroid(fishnet)),
k = 1
)
fishnet$graffiti_nn <- nn_dist$nn.dist[,1]
#### LOCAL MORAN'S I ANALYSIS
neighbors <- poly2nb(fishnet)
weights <- nb2listw(neighbors, style = "W", zero.policy = TRUE)
local_moran <- localmoran(
fishnet$countGraffiti,
weights,
zero.policy = TRUE
)
fishnet <- fishnet %>%
mutate(
local_I = local_moran[, "Ii"],
p_value = local_moran[, "Pr(z != E(Ii))"],
z_score = local_moran[, "Z.Ii"],
hotspot = ifelse(local_I > 0 & p_value < 0.05, 1, 0)
)
### DISTANCE TO HOTSPOT
hotspot_cells <- filter(fishnet, hotspot == 1)
hotspot_dist <- get.knnx(
data = st_coordinates(st_centroid(hotspot_cells)),
query = st_coordinates(st_centroid(fishnet)),
k = 1
)
fishnet$hotspot_nn <- hotspot_dist$nn.dist[, 1]
#### VISUALIZATION
# Create comparison maps
p1 <- ggplot(fishnet) +
geom_sf(aes(fill = graffiti_nn), color = NA, alpha = 0.8) +
scale_fill_viridis_c(name = "Distance (m)", option = "plasma", trans = "sqrt") +
labs(title = "Distance to Nearest Graffiti Removal Request") +
coord_sf() +
theme_minimal(base_size = 14)
p2 <- ggplot(fishnet) +
geom_sf(aes(fill = hotspot_nn), color = NA, alpha = 0.8) +
scale_fill_viridis_c(name = "Distance (m)", option = "magma", trans = "sqrt") +
labs(title = "Distance to Nearest Hotspot") +
coord_sf() +
theme_minimal(base_size = 14)
grid.arrange(p1, p2, ncol = 1)
#### POISSION MODEL
model_poisson <- glm(
countGraffiti ~ graffiti_nn + hotspot_nn,
data = fishnet,
family = poisson(link = "log")
)
exp(coef(model_poisson))
### SCALE FIT
fishnet_scale <- fishnet %>%
mutate(
log_graffiti = log1p(graffiti_nn),
log_hotspot = log1p(hotspot_nn)
)
#### NEGATIVE BINOMIAL REGRESSION
model_nb <- glm.nb(
countGraffiti ~ log_graffiti + log_hotspot,
data = fishnet_scale
)
### COMPARISON
AIC(model_poisson) #842,193.3
AIC(model_nb) #29,533.07
model_nb$theta #0.7300528
### LEAVE-ONE-GROUP-OUT CROSS VALIDATION
graffiti_2017 <- graffiti_data %>%
filter(year == 2017) %>%
filter(!is.na(Longitude), !is.na(Latitude)) %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)
crs_proj <- 26971
graffiti_2017 <- st_transform(graffiti_2017, crs_proj)
fishnet_2017 <- st_transform(fishnet, crs_proj)
counts <- lengths(st_intersects(fishnet_2017, graffiti_2017))
fishnet_2017 <- fishnet_2017 %>%
mutate(
countGraffiti = counts,
log_graffiti = log1p(graffiti_nn),
log_hotspot  = log1p(hotspot_nn)
)
### SPATIAL DISTRICTS
centroids <- st_centroid(fishnet_2017)
coords <- st_coordinates(centroids)
set.seed(123)
k <- 10
fishnet_2017$district <- as.factor(kmeans(coords, centers = k)$cluster)
### LEAVE-ONE-GROUP-OUT CROSS VALIDATION
cv_results <- list()
districts <- unique(fishnet_2017$district)
for (dist in districts) {
train_data <- fishnet_2017 %>% filter(district != dist)
test_data  <- fishnet_2017 %>% filter(district == dist)
model_cv <- glm.nb(
countGraffiti ~ log_graffiti + log_hotspot,
data = train_data
)
test_data$prediction <- predict(model_cv, newdata = test_data, type = "response")
cv_results[[as.character(dist)]] <- test_data
}
all_predictions <- bind_rows(cv_results)
### ERROR METRICS
cv_metrics <- all_predictions %>%
group_by(district) %>%
summarize(
MAE = mean(abs(countGraffiti - prediction)),
RMSE = sqrt(mean(countGraffiti - prediction)^2),
ME = mean(countGraffiti - prediction)
)
overall_MAE  <- mean(abs(all_predictions$countGraffiti - all_predictions$prediction))
overall_RMSE <- sqrt(mean((all_predictions$countGraffiti - all_predictions$prediction)^2))
overall_ME   <- mean(all_predictions$countGraffiti - all_predictions$prediction)
### PREP WORK
graffiti_points_proj <- st_transform(graffiti_points, crs_proj)
chicago_proj <- st_transform(chicago, crs_proj)
fishnet_proj <- st_transform(fishnet, crs_proj)
chicago_owin <- as.owin(chicago_proj)
graffiti_coords <- st_coordinates(graffiti_points_proj)
graffiti_points_proj <- graffiti_points_proj[, c("geometry", "year")]
fishnet_proj <- fishnet_proj[, c("geometry", "uniqueID")]
graffiti_ppp <- as.ppp(
X = graffiti_coords,
W = chicago_owin
)
### KDE
kde_surface <- density.ppp(
graffiti_ppp,
sigma = 1000,
edge = TRUE,
dimyx = c(300,300)
)
kde_raster <- raster(as.im(kde_surface))
fishnet_proj$kde_risk <- raster::extract(
kde_raster, st_coordinates(
st_centroid(fishnet_proj)))
fishnet_proj$kde_risk <- (fishnet_proj$kde_risk - min(fishnet_proj$kde_risk, na.rm = TRUE)) /
max(fishnet_proj$kde_risk, na.rm = TRUE) - min(fishnet_proj$kde_risk, na.rm = TRUE)
fishnet_proj$kde_risk_category <- cut(
fishnet_proj$kde_risk,
breaks = quantile(fishnet_proj$kde_risk, probs = seq(0, 1, 0.2), na.rm = TRUE),
labels = c("1st (Lowest)", "2nd", "3rd", "4th", "5th (Highest)"),
include.lowest = TRUE
)
pred_df <- all_predictions[, c("uniqueID", "model_risk_category")]
colnames(all_predictions)
pred_df <- all_predictions[, c("uniqueID")]
fishnet <- st_join(fishnet, pred_df, by = "uniqueID")
graffiti_2017 <- graffiti_points %>% filter(year == 2017)
model_results <- fishnet_proj %>%
st_join(graffiti_2017, left = FALSE) %>%
st_drop_geometry() %>%
group_by(model_risk_category) %>%
summarize(graffiti_2017 = n(), .groups = "drop") %>%
mutate(pct_of_total = 100 * graffiti_2017 / sum(graffiti_2017))
head(all_predictions)
all_predictions$predicted_count <- predict(model_nb, newdata = fishnet_proj, type = "response")
all_predictions$predicted_count <- predict(model_nb, newdata = fishnet_proj, type = "response")
### RESULTS
model_results <- fishnet_proj %>%
st_join(graffiti_2017, left = FALSE) %>%
st_drop_geometry() %>%
group_by(model_risk_category) %>%
summarize(graffiti_2017 = n(), .groups = "drop") %>%
mutate(pct_of_total = 100 * graffiti_2017 / sum(graffiti_2017))
names(model_nb$coefficients)
fishnet_proj$log_graffiti <- log(fishnet_proj$graffiti_nn + 1)
colnames(fishnet_proj)
fishnet_proj$countGraffiti <- lengths(st_intersects(fishnet_proj, graffiti_points_proj))
fishnet_proj$hotspot_count <- lengths(st_intersects(fishnet_proj, hotspot_points_proj))
fishnet_proj$log_graffiti <- log(fishnet_proj$countGraffiti + 1)
fishnet_proj$log_hotspot <- log(fishnet_proj$hotspot_count + 1)
fishnet_proj$hotspot_count <- lengths(st_intersects(fishnet_proj, hotspot_points_proj))
hotspot_point_proj <- st_as_sf(hotspot_cells, coords = c("Longitude", "Latitude"), crs = crs_proj)
hotspot_point_proj <- st_transform(hotspot_point_proj, crs_proj)
fishnet_proj$hotspot_count <- lengths(st_intersects(fishnet_proj, hotspot_points_proj))
fishnet_proj$hotspot_count <- lengths(st_intersects(fishnet_proj, hotspot_point_proj))
fishnet_proj$countGraffiti <- lengths(st_intersects(fishnet_proj, graffiti_points_proj))
fishnet_proj$log_graffiti <- log(fishnet_proj$countGraffiti + 1)
fishnet_proj$log_hotspot <- log(fishnet_proj$hotspot_count + 1)
fishnet_proj$predicted_count <- predict(model_nb, newdata = fishnet_proj, type = "response")
### PREP WORK
graffiti_points_proj <- st_transform(graffiti_points, crs_proj)
chicago_proj <- st_transform(chicago, crs_proj)
fishnet_proj <- st_transform(fishnet, crs_proj)
chicago_owin <- as.owin(chicago_proj)
graffiti_coords <- st_coordinates(graffiti_points_proj)
graffiti_points_proj <- graffiti_points_proj[, c("geometry", "year")]
fishnet_proj <- fishnet_proj[, c("geometry", "uniqueID")]
### PREP WORK
graffiti_points_proj <- st_transform(graffiti_points, crs_proj)
chicago_proj <- st_transform(chicago, crs_proj)
fishnet_proj <- st_transform(fishnet, crs_proj)
chicago_owin <- as.owin(chicago_proj)
graffiti_coords <- st_coordinates(graffiti_points_proj)
graffiti_points_proj <- graffiti_points_proj[, c("geometry", "year")]
graffiti_ppp <- as.ppp(
X = graffiti_coords,
W = chicago_owin
)
### KDE
kde_surface <- density.ppp(
graffiti_ppp,
sigma = 1000,
edge = TRUE,
dimyx = c(300,300)
)
kde_raster <- raster(as.im(kde_surface))
hotspot_point_proj <- st_as_sf(hotspot_cells, coords = c("Longitude", "Latitude"), crs = crs_proj)
hotspot_point_proj <- st_transform(hotspot_point_proj, crs_proj)
fishnet_proj$hotspot_count <- lengths(st_intersects(fishnet_proj, hotspot_point_proj))
fishnet_proj$countGraffiti <- lengths(st_intersects(fishnet_proj, graffiti_points_proj))
fishnet_proj$log_graffiti <- log(fishnet_proj$countGraffiti + 1)
fishnet_proj$log_hotspot <- log(fishnet_proj$hotspot_count + 1)
fishnet_proj$predicted_count <- predict(model_nb, newdata = fishnet_proj, type = "response")
fishnet_proj$kde_risk_category <- cut(
fishnet_proj$kde_risk,
breaks = quantile(fishnet_proj$kde_risk, probs = seq(0, 1, 0.2), na.rm = TRUE),
labels = c("1st (Lowest)", "2nd", "3rd", "4th", "5th (Highest)"),
include.lowest = TRUE
)
fishnet_proj$model_risk_category <- cut(
fishnet_proj$predicted_count,
breaks = quantile(fishnet_proj$predicted_count, probs = seq(0,1,0.2), na.rm = TRUE),
labels = c("1st (Lowest)", "2nd", "3rd", "4th", "5th (Highest)"),
include.lowest = TRUE
)
hotspot_sf <- st_as_sf(hotspot_cells, coords = c("Longitude", "Latitude"), crs = crs_proj)
fishnet_proj$hotspot_count <- lengths(st_intersects(fishnet_proj, hotspot_sf))
fishnet_proj$countGraffiti <- lengths(st_intersects(fishnet_proj, graffiti_proj))
graffitiproj <- graffiti_proj[, c("geometry", "year")]
model_nb <- glm.nb(countGraffiti ~ log_graffiti + log_hotspot, data = fishnet_proj)
fishnet_proj$predicted_count <- predict(model_nb, newdata = fishnet_proj, type = "response")
fishnet_proj$model_risk_category <- cut(
fishnet_proj$predicted_count,
breaks = quantile(fishnet_proj$predicted_count, probs = seq(0, 1, 0.2), na.rm = TRUE),
labels = c("1st (Lowest)", "2nd", "3rd", "4th", "5th (Highest)"),
include.lowest = TRUE
)
fishnet_proj$kde_risk <- raster::extract(kde_raster, st_coordinates(st_centroid(fishnet_proj)))
fishnet_proj$kde_risk <- (fishnet_proj$kde_risk - min(fishnet_proj$kde_risk, na.rm = TRUE)) / (max(fishnet_proj$kde_risk, na.rm = TRUE) - min(fishnet_proj$kde_risk, na.rm = TRUE))
fishnet_proj$kde_risk_category <- cut(
fishnet_proj$kde_risk,
breaks = quantile(fishnet_proj$kde_risk, probs = seq(0,1,0.2), na.rm = TRUE),
labels = c("1st (Lowest)", "2nd", "3rd", "4th", "5th (Highest)"),
include.lowest = TRUE
)
graffiti_2017 <- graffiti_points %>% filter(year == 2017)
results_2017_model <- fishnet_proj %>%
st_join(graffiti_2017, left = FALSE) %>%
st_drop_geometry() %>%
group_by(model_risk_category) %>%
summarize(graffiti_2017 = n(), .groups = "drop") %>%
mutate(pct_of_total = 100 * graffiti_2017 / sum(graffiti_2017))
results_2017_kde <- fishnet_proj %>%
st_join(graffiti_2017, left = FALSE) %>%
st_drop_geometry() %>%
group_by(kde_risk_category) %>%
summarize(graffiti_2017 = n(), .groups = "drop") %>%
mutate(pct_of_total = 100 * graffiti_2017 / sum(graffiti_2017))
comparison_data <- bind_rows(
results_2017_model %>%
mutate(Method = "Negative Binomial Model") %>%
rename(risk_category = model_risk_category),
results_2017_kde %>%
mutate(Method = "Kernel Density") %>%
rename(risk_category = kde_risk_category)
)
ggplot(comparison_data, aes(x = risk_category, y = pct_of_total, fill = Method)) +
geom_bar(stat = "identity", position = "dodge") +
scale_fill_manual(values = c("darkgreen", "deeppink4")) +
labs(
title = "Percentage of 2017 Graffiti Requests Captured",
subtitle = "Negative Binomial Model vs KDE Baseline",
x = "Risk Category",
y = "% of Total 2017 Graffiti Requests"
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold"),
plot.subtitle = element_text(face = "italic"),
legend.position = "bottom"
)
### CLEAN AND SUMMARIZE DATA
setwd("/Users/hope/Documents/GitHub/portfolio-setup-hlevin13/assignments/lab_4")
graffiti_data <- read_csv("GraffitiRemoval.csv")
### CLEAN AND SUMMARIZE DATA
setwd("/Users/hope/Documents/GitHub/portfolio-setup-hlevin13/assignments/lab_4")
graffiti_data <- read_csv("GraffitiRemoval.csv")
graffiti_data <- graffiti_data %>%
mutate(
`Creation Date` = mdy(`Creation Date`),
`Completion Date` = mdy(`Completion Date`),
year = year(`Creation Date`),
month = month(`Creation Date`),
completed = as.integer(Status == "Completed"),
days_to_complete = as.numeric(
difftime(`Completion Date`, `Creation Date`, units = "days")
))
graffiti_data <- graffiti_data %>%
dplyr::select(
completed,
year,
month,
days_to_complete,
Longitude,
Latitude
) %>%
na.omit()
cat("Completion rate:", round(mean(graffiti_data$completed), 3), "\n")
summary <- graffiti_data %>%
summarise(
mean_days = mean(days_to_complete, na.rm = TRUE),
median_days = median(days_to_complete, na.rm = TRUE),
min_days = min(days_to_complete, na.rm = TRUE),
max_days = max(days_to_complete, na.rm = TRUE)
)
### CHICAGO SPATIAL BOUNDARIES
chicago <- st_read("/Users/hope/Documents/GitHub/portfolio-setup-hlevin13/assignments/lab_4/Chicago.geojson")
ggplot(chicago) +
geom_sf() +
theme_minimal()
graffiti_data <- graffiti_data %>%
mutate(
Longitude = as.numeric(Longitude),
Latitude  = as.numeric(Latitude)
) %>%
filter(!is.na(Longitude), !is.na(Latitude))
graffiti_data <- graffiti_data %>%
filter(
Longitude >= -87.95 & Longitude <= -87.50,
Latitude  >= 41.63 & Latitude  <= 42.05
)
graffiti_sf <- graffiti_data %>%
st_as_sf(coords = c("Longitude", "Latitude"), crs = 4326)
### VISUALIZATION
graffiti_sf <- graffiti_sf %>%
mutate(completed = factor(completed, levels = c(0, 1), labels = c("Incomplete", "Completed")))
ggplot() +
geom_sf(data = chicago, fill = "white", color = "black") +
geom_sf(
data = graffiti_sf,
aes(color = completed),
alpha = 0.5,
size = 1
) +
scale_color_manual(values = c("Incomplete" = "red", "Completed" = "green"))+
labs(
title = "Distribution of Graffiti Removal Requests in Chicago",
subtitle = "Based on Chicago 311 Service Requests",
color = "Request Status"
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold"),
plot.subtitle = element_text(face = "italic"),
legend.position = "bottom"
)
ggplot(comparison_data, aes(x = risk_category, y = pct_of_total, fill = Method)) +
geom_bar(stat = "identity", position = "dodge") +
scale_fill_manual(values = c("darkgreen", "deeppink4")) +
labs(
title = "Percentage of 2017 Graffiti Requests Captured",
subtitle = "Negative Binomial Model vs KDE Baseline",
x = "Risk Category",
y = "% of Total 2017 Graffiti Requests"
) +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold"),
plot.subtitle = element_text(face = "italic"),
legend.position = "bottom"
)
library(MASS)
model_nb <- glm.nb(
countGraffiti ~ log_graffiti + log_hotspot,
data = fishnet_scale
)
library(MASS)
exists("glm.nb")
# should return TRUE
library(tidyverse)
library(caret)
library(pROC)
library(here)
library(sf)
library(ggplot2)
library(lubridate)
library(FNN)
library(spdep)
library(gridExtra)
library(Metrics)
library(spatstat)
library(raster)
library(dplyr)
library(MASS)
set.seed(2025)
theme_set(theme_minimal())
library(MASS)
exists("glm.nb")
library(tidyverse)
library(caret)
library(pROC)
library(here)
library(sf)
library(ggplot2)
library(lubridate)
library(FNN)
library(spdep)
library(gridExtra)
library(Metrics)
library(spatstat)
library(raster)
library(dplyr)
library(MASS)
set.seed(2025)
theme_set(theme_minimal())
print(exists("glm.nb"))
library(MASS)
exists("glm.nb")
install.packages("MASS", repos="https://cloud.r-project.org")
library(MASS)
exists("glm.nb")  # should return TRUE
install.packages("MASS", repos = "https://cloud.r-project.org")
library(MASS)
exists("glm.nb")
q()
